// Copyright (c) Microsoft Corporation.  All Rights Reserved.
// Licensed under the Apache License, Version 2.0.  See License.txt in the project root for license information.

using System.Linq;
using CommandLine;
using FluentAssertions;
using Microsoft.Json.Schema.ToDotNet.CommandLine;
using Xunit;

namespace Microsoft.Json.Schema.ToDotNet.UnitTests
{
    public class CommandLineTests
    {
        [Fact]
        public void CorrectlyParseGenerateJsonIntegerAs()
        {
            (string argsString, GenerateJsonIntegerOption? expectedGenerateJsonIntegerAs, string expectedErrorParameter)[] testCases = new[]
            {
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.Int, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=Int", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.Int, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=int", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.Int, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=INT", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.Int, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=iNT", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.Int, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=long", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.Long, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=biginteger", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.BigInteger, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=auto", (GenerateJsonIntegerOption?)GenerateJsonIntegerOption.Auto, null),
                ("--schema-name Sarif --schema-file-path \"C:\\sarif.json\" --output-directory \"C:\\Autogenerated\" --namespace-name Microsoft.CodeAnalysis.Sarif --root-class-name SarifLog --generate-json-integer-as=unknown", (GenerateJsonIntegerOption?)null, "generate-json-integer-as"),
            };

            foreach ((string argsString, GenerateJsonIntegerOption? expectedGenerateJsonIntegerAs, string expectedErrorParameter) testCase in testCases)
            {
                var args = testCase.argsString.Split(' ');
                var parser = new Parser(cfg => cfg.CaseInsensitiveEnumValues = true).ParseArguments<Options>(args)
                    .MapResult(
                    options =>
                    {
                        testCase.expectedGenerateJsonIntegerAs.Should().NotBeNull();
                        testCase.expectedErrorParameter.Should().BeNull();
                        options.GenerateJsonIntegerAs.Should().Be(testCase.expectedGenerateJsonIntegerAs);
                        return true;
                    },
                    err =>
                    {
                        testCase.expectedGenerateJsonIntegerAs.Should().BeNull();
                        testCase.expectedErrorParameter.Should().NotBeNull();
                        var allErrors = err.ToList();
                        allErrors.Should().HaveCount(1);
                        allErrors[0].Should().BeOfType(typeof(BadFormatConversionError));
                        ((NamedError)allErrors[0]).NameInfo.NameText.Should().Be(testCase.expectedErrorParameter);
                        return true;
                    });
            }
        }
    }
}
